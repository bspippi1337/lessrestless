name: CI

on:
  push:
    branches: ["main", "release"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  go-ci:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: Environment snapshot
        shell: bash
        run: |
          set -euo pipefail
          uname -a
          go version
          git status --porcelain || true

      - name: Doctor (self-heal + cycle check)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f scripts/doctor.sh ]; then
            bash scripts/doctor.sh
          else
            echo "No scripts/doctor.sh; skipping."
          fi

      - name: Go fmt check (non-destructive)
        shell: bash
        run: |
          set -euo pipefail
          unformatted="$(gofmt -l . | head -n 200 || true)"
          if [ -n "$unformatted" ]; then
            echo "gofmt needed on:"
            echo "$unformatted"
            exit 1
          fi

      - name: Go mod tidy check
        shell: bash
        run: |
          set -euo pipefail
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Test (pure-go)
        shell: bash
        env:
          CGO_ENABLED: "0"
        run: |
          set -euo pipefail
          go test ./... -count=1 -tags "netgo osusergo"

      - name: Build (pure-go)
        shell: bash
        env:
          CGO_ENABLED: "0"
        run: |
          set -euo pipefail
          mkdir -p dist
          go build -trimpath -ldflags "-s -w" -tags "netgo osusergo" -o dist/restless ./cmd/restless

      - name: Upload artifact (restless)
        uses: actions/upload-artifact@v4
        with:
          name: restless-linux-amd64
          path: dist/restless
          if-no-files-found: error
